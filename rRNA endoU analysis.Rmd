---
title: "Analysis of rRNA to Detect EndoU Cleavage Sites"
author: "Rachel Ancar"
date: "04/25/2018"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
```

Prior to this analysis, 2´3´-cyclic phosphate RNA-sequencing libraries were prepared from mouse macrophages: B6 (WT), IFNAR KO, RNaseL KO. These cells were either mock infected or infected with WT MHV virus (from Volker or Susan), MHV mutated to inactivate ns2 (phosphodiesterase) activity, or MHV mutated to inactivate nsp15 (endoribonuclease) activity for 9 and 12 hours. 

These libraries were processed to generate bedgraph files containing sites of 3´-cleavage and the associated dinucleotide for 18S, 28S, and 5s rRNA. 

```{r message = F, warning = F}

library(tidyverse)
library(readr)
library(dplyr)
library(ggplot2)
library(valr)
library(stringr)
library(cowplot)
library(RColorBrewer)
library(purrr)
library(shiny)
library(DT)

```

##Coverage plots for 18S, 28S, and 5s rRNA by cell type and type of viral infection

These plots display coverage across the entire 18S, 28S, and 5s rRNA sequence. Counts are normalized by library size. 

```{r message = F, warning = F}

sample_info_table <- read_tsv("sample_info.txt", col_names = c("cell type", "virus type", "time"))
datatable(sample_info_table)

#18S rRNA coverage plots

data_dir_18S = "~/Dropbox (Hesselberth Lab)/Rachel_data/EndoU_project/rRNA_bg/mm18S/neg/"
data_files_18S = list.files(data_dir_18S, full.names = T)

read_file <- function(x) {
  df <- readr::read_tsv(x, col_names = c("chrom", "start", "end", "count", "normalized_count", "dinuc"))
  df$name <- basename(x)
  df
}

table_18S <- purrr::map_df(data_files_18S, read_file) %>%
  mutate(name = str_replace(name, ".umi.18S.dinuc.neg.bg", "")) %>%
  separate(name, into = c('cell', 'virus', 'time'), sep = '_')

plot_18S <- ggplot(table_18S, aes(x = start, y = normalized_count)) +
    #geom_bar(aes(fill = time), stat = "identity", position = 'dodge') 
    geom_line(aes(color = time)) + 
    scale_color_brewer(palette = 'Set1') + 
    theme_cowplot() +
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
    scale_x_continuous(breaks=seq(0, 2000, 250)) + 
    labs(x="Position", y="Normalized counts (counts/total reads)") +
    ggtitle("18S rRNA coverage plots")
plot_18S

# Previously documented RNaseL cleavage site 542 and 771 in 18S rRNA

plot_18S_542 <- ggplot(table_18S, aes(x = start, y = normalized_count, fill = time)) +
    geom_bar(stat = "identity", position = 'dodge') +
    #geom_line(aes(color = time)) + 
    scale_fill_brewer(palette = 'Set1') + 
    theme_cowplot() +
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    labs(x="Position", y="Normalized counts (counts/total reads)") +
    xlim(530, 560) +
    ggtitle("RNaseL cleavage site 542 in 18S rRNA")
plot_18S_542

plot_18S_771 <- ggplot(table_18S, aes(x = start, y = normalized_count, fill = time)) +
    geom_bar(stat = "identity", position = 'dodge') +
    #geom_line(aes(color = time)) + 
    scale_fill_brewer(palette = 'Set1') + 
    theme_cowplot() +
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    labs(x="Position", y="Normalized counts (counts/total reads)") +
    xlim(760, 780) +
    ggtitle("RNaseL cleavage site 771 in 18S rRNA")
plot_18S_771

#28S rRNA coverage plots

data_files_28S = list.files("~/Dropbox (Hesselberth Lab)/Rachel_data/EndoU_project/rRNA_bg/mm28S/neg/" , full.names = T)

read_file <- function(x) {
  df <- readr::read_tsv(x, col_names = c("chrom", "start", "end", "count", "normalized_count", "dinuc"))
  df$name <- basename(x)
  df
}

table_28S <- purrr::map_df(data_files_28S, read_file) %>%
  mutate(name = str_replace(name, ".umi.28S.dinuc.neg.bg", "")) %>%
  separate(name, into = c('cell', 'virus', 'time'), sep = '_')

plot_28S <- ggplot(table_28S, aes(x = end, y = normalized_count)) +
    #geom_bar(aes(fill = time), stat = "identity", position = 'dodge') +
    geom_line(aes(color = time)) + 
    scale_colour_brewer(palette = 'Set1') + 
    theme_cowplot() +
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_x_continuous(breaks=seq(0, 5000, 500)) + 
    labs(x="Position", y="Normalized counts (counts/total reads)") +
    ggtitle("28S rRNA coverage plots")
plot_28S

#5S rRNA

data_dir_5S = "~/Dropbox (Hesselberth Lab)/Rachel_data/EndoU_project/rRNA_bg/mm5S/neg"
data_files_5S = list.files(data_dir_5S, full.names = T)

read_file <- function(x) {
  df <- readr::read_tsv(x, col_names = c("chrom", "start", "end", "count", "normalized_count", "dinuc"))
  df$name <- basename(x)
  df
}

table_5S <- purrr::map_df(data_files_5S, read_file) %>%
  mutate(name = str_replace(name, ".umi.5S.dinuc.neg.bg", "")) %>%
  separate(name, into = c('cell', 'virus', 'time'), sep = '_')

plot_5S <- ggplot(table_5S, aes(x = end, y = normalized_count)) +
    #geom_bar(aes(fill = time), stat = "identity", position = 'dodge') +
    geom_line(aes(color = time)) + 
    scale_colour_brewer(palette = 'Set1') + 
    theme_cowplot() + 
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_x_continuous(breaks=seq(0, 200, 20)) + 
    labs(x="Position", y="Normalized counts (counts/total reads)") +
    ggtitle("5S rRNA coverage plots")
plot_5S

```

###Disscusion of ribosomal RNA coverage plots

First, it is clear that there is signfiicant non-specific cleavage of ribosomal RNA that has been captured in these libaries. There is robust cleavage in the mock samples of all analyzed rRNAs. Across all rRNAs and conditions, most cleavage is detected at 9 vs. 12 hpi. The exception to this observation is for rRNA cleavage from B6 cells infected with MHV ns2 mutant. In these cells, there is more clevage at 12 hpi, which may be a reflection of specific increased RNase L activation. The 5s rRNA signal does not follow these patterns observed in the 18s and 28 rRNA. The 5s rRNA signal in general is much lower and there do not seem to be any speciifc changes in signal captured across cell type or infection. 

Speciifc cleavage can still be detected at the known RNase L cleavage site in 18s rRNA at nucleotide 542. At this site, there is very little cleavage in the mock samples, and clear induction of cleavage at this site in B6 cells infected with the nsp15 mutant relative to the other virus types. 

Overall, it is difficult to determine if there are any specific sites of clevaage that change in the abscence of nsp15 activity due to the signfiicant background signal. 

##RNase L substractive coverage analysis of rRNA reads for all cell types by type of viral infection 

The normalized counts detected in RNase L KO cells for each type of viral infection were subtracted from the normalized counts detected in WT B6 and IFNAR KO cells. This substractive analysis will emphasize RNase L dependent cleavage events by reporting signals that occur only in the presence of RNase L. 

```{r message = F, warning = F}

#18S rRNA RNase L substractive analysis 

subtractive_18S <- table_18S %>% 
  dplyr::select(-count, -dinuc) %>% 
  spread(cell, normalized_count) 
subtractive_18S[is.na(subtractive_18S)] <- 0

subtractive_18S <- subtractive_18S %>% 
  mutate(B6_RNaseL = B6 - RNaseL) %>% 
  mutate(IFNAR_RNaseL = IFNAR - RNaseL) %>%                     
  dplyr::select(start:end, virus:time, B6_RNaseL:IFNAR_RNaseL) %>%       gather(cell, normalized_count, B6_RNaseL:IFNAR_RNaseL)
                                      
#18s rRNA RNase L dependent cleavage plots

sub18S_plot <- ggplot(subtractive_18S, aes(x = end, y = normalized_count)) +
    #geom_bar(aes(fill = time), stat = "identity", position = 'dodge') +
    geom_line(aes(color = time)) + 
    scale_color_brewer(palette = 'Set1') + 
    theme_cowplot() +
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    labs(x="Position", y="Normalized counts (counts/total reads)") + 
    scale_y_continuous(limits = c(0 , 0.02)) +
    scale_x_continuous(breaks=seq(0, 2000, 250)) + 
    ggtitle("18s rRNA RNase L dependent cleavage plots")
sub18S_plot

#28S rRNA RNase L substractive analysis 

subtractive_28S <- table_28S %>% 
  dplyr::select(-count, -dinuc) %>% 
  spread(cell, normalized_count) 
subtractive_28S[is.na(subtractive_28S)] <- 0

subtractive_28S <- subtractive_28S %>% 
  mutate(B6_RNaseL = B6 - RNaseL) %>% 
  mutate(IFNAR_RNaseL = IFNAR - RNaseL) %>% 
  dplyr::select(start:end, virus:time, B6_RNaseL:IFNAR_RNaseL) %>%      gather(cell, normalized_count, B6_RNaseL:IFNAR_RNaseL)

#28s rRNA RNase L dependent cleavage plots
                                      
sub28S_plot <- ggplot(subtractive_28S, aes(x = end, y = normalized_count)) +
    #geom_bar(aes(fill = time), stat = "identity", position = 'dodge') +
    geom_line(aes(color = time)) + 
    scale_color_brewer(palette = 'Set1') + 
    theme_cowplot() +
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +                  scale_y_continuous(limits = c(0 , 0.02)) +
    scale_x_continuous(breaks=seq(0, 5000, 500)) + 
   ggtitle("28s rRNA RNase L dependent cleavage plots")
sub28S_plot

#5S rRNA RNase L substractive analysis 

subtractive_5S <- table_5S %>% 
  dplyr::select(-count, -dinuc) %>% 
  spread(cell, normalized_count) 
subtractive_5S[is.na(subtractive_5S)] <- 0

subtractive_5S <- subtractive_5S %>% 
  mutate(B6_RNaseL = B6 - RNaseL) %>% 
  mutate(IFNAR_RNaseL = IFNAR - RNaseL) %>% 
  dplyr::select(start:end, virus:time, B6_RNaseL:IFNAR_RNaseL) %>%    
  gather(cell, normalized_count, B6_RNaseL:IFNAR_RNaseL)

#5s rRNA RNase L dependent cleavage plots
                                      
sub5S_plot <- ggplot(subtractive_5S, aes(x = end, y = normalized_count, fill = time)) +
    geom_bar(stat = "identity", position = 'dodge') +
    #geom_line(aes(color = time)) + 
    scale_fill_brewer(palette = 'Set1') + 
    theme_cowplot() + 
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +              
    scale_y_continuous(limits = c(0 , 0.005)) +
    scale_x_continuous(breaks=seq(0, 200, 20)) + 
    ggtitle("5s rRNA RNase L dependent cleavage plots")
sub5S_plot

```

###Discussion of RNase L subtractive analysis: 

In the 18s and 28 rRNA, there is still significant signal in the mock samples, which seems to occur generally across the rRNA sequence without a preference for time. However, the signal in the treated samples do have a more pronounced pattern preference across the RNA, and the RNase L signal occurs most robustly at 12 hpi, except in the nsp15 mutant viral infection, where the signal is most enriched at 9 hpi. In the 5s rRNA analysis, there aren't any clear or consistent cleavage patterns between cell type of viral infection type. 

##EndoU mutant (nsp15) substractive coverage analysis of MHV (+) strand for all cell types by type of viral infection

This is very similar to the analysis above, expect it will substract signal occuring in the abscence of nsp15 actviity, which will emphasize sites specific to nsp15 cleavage actviity. 

```{r message = F, warning = F}

#18S rRNA EndoU substractive analysis 

subtractive_nsp15_18S <- table_18S %>% 
  dplyr::select(-count, -dinuc) %>% 
  spread(virus, normalized_count) 
subtractive_nsp15_18S[is.na(subtractive_nsp15_18S)] <- 0

subtractive_nsp15_18S <- subtractive_nsp15_18S %>%       
  mutate(MHVS_nsp15 = MHVS - nsp15) %>%
  mutate(MHVV_nsp15 = MHVV - nsp15) %>%
  mutate(ns2_nsp15 = ns2 - nsp15) %>%
  mutate(mock_nsp15 = mock - nsp15) %>%
  dplyr::select(start:end, cell:time, MHVS_nsp15:mock_nsp15) %>% 
  gather(virus, normalized_count, MHVS_nsp15:mock_nsp15)
                                      
subnsp15_18S_plot <- ggplot(subtractive_nsp15_18S, aes(x = end, y = normalized_count)) +
    #geom_bar(aes(fill = time), stat = "identity", position = 'dodge') + 
    geom_line(aes(color = time)) + 
    scale_color_brewer(palette = 'Set1') + 
    theme_cowplot() + 
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +  
    scale_y_continuous(limits = c(0.0, 0.02)) +
    scale_x_continuous(breaks=seq(0, 2000, 250)) + 
    ggtitle("18S rRNA EndoU substractive analysis ")
subnsp15_18S_plot

#28S

subtractive_nsp15_28S <- table_28S %>% 
  dplyr::select(-count, -dinuc) %>% 
  spread(virus, normalized_count) 
subtractive_nsp15_28S[is.na(subtractive_nsp15_28S)] <- 0

subtractive_nsp15_28S <- subtractive_nsp15_28S %>%   
  mutate(MHVS_nsp15 = MHVS - nsp15) %>% 
  mutate(MHVV_nsp15 = MHVV - nsp15) %>% 
  mutate(ns2_nsp15 = ns2 - nsp15) %>% mutate(mock_nsp15 = mock - nsp15) %>% 
  dplyr::select(start:end, cell:time, MHVS_nsp15:mock_nsp15) %>%    gather(virus, normalized_count, MHVS_nsp15:mock_nsp15)
                                      
subnsp15_28S_plot <- ggplot(subtractive_nsp15_28S, aes(x = end, y = normalized_count)) +
    #geom_bar(aes(fill = time), stat = "identity", position = 'dodge') +
    geom_line(aes(color = time)) + 
    scale_color_brewer(palette = 'Set1') + 
    theme_cowplot() + 
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +     
    scale_y_continuous(limits = c(0.0, 0.02)) +
    scale_x_continuous(breaks=seq(0, 5000, 500)) + 
    ggtitle("28S rRNA EndoU substractive analysis ")
subnsp15_28S_plot

#5S

subtractive_nsp15_5S <- table_5S %>% 
  dplyr::select(-count, -dinuc) %>% 
  spread(virus, normalized_count) 
subtractive_nsp15_5S[is.na(subtractive_nsp15_5S)] <- 0

subtractive_nsp15_5S <- subtractive_nsp15_5S %>% 
  mutate(MHVS_nsp15 = MHVS - nsp15) %>% 
  mutate(MHVV_nsp15 = MHVV - nsp15) %>% 
  mutate(ns2_nsp15 = ns2 - nsp15) %>% 
  mutate(mock_nsp15 = mock - nsp15) %>% 
  dplyr::select(start:end, cell:time, MHVS_nsp15:mock_nsp15) %>%    gather(virus, normalized_count, MHVS_nsp15:mock_nsp15)
                                      
subnsp15_5S_plot <- ggplot(subtractive_nsp15_5S, aes(x = end, y = normalized_count)) +
    #geom_bar(aes(fill = time), stat = "identity", position = 'dodge') +
    geom_line(aes(color = time)) + 
    scale_color_brewer(palette = 'Set1') + 
    theme_cowplot() + 
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +                   scale_y_continuous(limits = c(0.0, 0.02)) +
    scale_x_continuous(breaks=seq(0, 200, 20)) + 
    ggtitle("5S rRNA EndoU substractive analysis ")
subnsp15_5S_plot


```

###Discussion of nsp15 substractive analysis:

In the 18 and 28 rRNA, there is significant signal in the mock samples across the entire rRNA. In the treated samples, the B6 WT cells the signal occurs at specific regions of the RNA and occurs most robustly at 12 hpi. There is very little cleavage in the IFNAR KO cells that is nsp15 dependent. However, there is signal dectected across the entire RNA in the two MHV WT virus infections in RNase L KO cells, but this may be non-specific because the pattern is similar to that observed in the mock. While these data are noisy, in general there does seem to be a pattern suggesting some type of interaction between nsp15 activity and IFN signalling, and perhaps a type of competition when there is active RNAse L. There is almost no nsp15 dependent signal in the 5s rRNA. 

##Baseline subtractive analysis: remvoving reads that occur in the mock infected samples

This analysis attempts to establish a signal "baseline" by determining the signal at each base in the RNA that remains after subtracting the signal that occured in the mock samples at the same base.  

```{r message = F, warning = F}

#18S mock subtractive analysis 

subtractive_mock_18S <- table_18S %>% 
  dplyr::select(-count, -dinuc) %>% 
  spread(virus, normalized_count) 
subtractive_mock_18S[is.na(subtractive_mock_18S)] <- 0

subtractive_mock_18S <- subtractive_mock_18S %>% 
  mutate(MHVSbase = MHVS - mock) %>% 
  mutate(MHVVbase = MHVV - mock) %>% 
  mutate(ns2base = ns2 - mock) %>% 
  mutate(nsp15base = nsp15 - mock) %>% 
  dplyr::select(chrom:end, cell:time, MHVSbase:nsp15base) %>% 
  gather(virus, normalized_count, MHVSbase:nsp15base)
                                      
submock_18S_plot <- ggplot(subtractive_mock_18S, aes(x = end, y = normalized_count)) +
    geom_line(aes(color = time)) + 
    scale_colour_brewer(palette = 'Set1') + 
    theme_cowplot() + 
    scale_y_continuous(limits = c(0, 0.03)) + 
    labs(x="Position", y="Normalized counts (counts/total reads)") +
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
     scale_x_continuous(breaks=seq(0, 2000, 250)) + 
    ggtitle("18S rRNA baseline coverage plots ") 
submock_18S_plot

#28S mock subtractive analysis 

subtractive_mock_28S <- table_28S %>% 
  dplyr::select(-count, -dinuc) %>% 
  spread(virus, normalized_count) 
subtractive_mock_28S[is.na(subtractive_mock_28S)] <- 0

subtractive_mock_28S <- subtractive_mock_28S %>% 
  mutate(MHVSbase = MHVS - mock) %>% 
  mutate(MHVVbase = MHVV - mock) %>% 
  mutate(ns2base = ns2 - mock) %>% 
  mutate(nsp15base = nsp15 - mock) %>% 
  dplyr::select(start:end, cell:time, MHVSbase:nsp15base) %>%     gather(virus, normalized_count, MHVSbase:nsp15base)
                                      
submock_28S_plot <- ggplot(subtractive_mock_28S, aes(x = end, y = normalized_count)) +
    geom_line(aes(color = time)) + 
    scale_color_brewer(palette = 'Set1') + 
    theme_cowplot() + 
    scale_y_continuous(limits = c(0, 0.03)) + 
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_x_continuous(breaks=seq(0, 5000, 500)) + 
    ggtitle("28S rRNA baseline coverage plots") 
submock_28S_plot

#5S mock subtractive analysis 

subtractive_mock_5S <- 
  table_5S %>% 
  dplyr::select(-count, -dinuc) %>% 
  spread(virus, normalized_count) 
subtractive_mock_5S[is.na(subtractive_mock_5S)] <- 0

subtractive_mock_5S <- subtractive_mock_5S %>% 
  mutate(MHVSbase = MHVS - mock) %>% 
  mutate(MHVVbase = MHVV - mock) %>% 
  mutate(ns2base = ns2 - mock) %>% 
  mutate(nsp15base = nsp15 - mock) %>% 
  dplyr::select(start:end, cell:time, MHVSbase:nsp15base) %>% 
  gather(virus, normalized_count, MHVSbase:nsp15base)
                                      
submock_5S_plot <- ggplot(subtractive_mock_5S, aes(x = end, y = normalized_count, fill = time)) +
    geom_bar(aes(fill = time), stat = "identity", position = 'dodge') +
    #geom_line(aes(color = time)) + 
    scale_fill_brewer(palette = 'Set1') + 
    theme_cowplot() + 
    scale_y_continuous(limits = c(0, 0.01)) + 
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_x_continuous(breaks=seq(0, 200, 20)) + 
    ggtitle("5S rRNA baseline coverage plots") 
submock_5S_plot


```

###Discussion of baseline analysis

Removing the signal that occured in the mock samples reveals a few differenes as compared to the inital coverage graphs. In the 18s and 28s rRNA most of the captured signal is at 12 hpi and the MHVV virus infected samples have the lowest cleavage across all cell types. The pattern of cleavage shifts a bit in the RNase L KO cells as compared to the B6 and IFNAR KO cells, but there aren't any clear sites of nsp15 dependent cleavage relative to the background. 

In the 5s rRNA, after removing signal from the mock samples, there is very little clevage evident in the RNA. There does seem to be a signal around nt 50 that may be RNase L dependent. 

##EndoU mutant (nsp15) substractive coverage analysis of MHV (+) strand for all cell types by type of viral infection from baseline

```{r message = F, warning = F}

#18S nsp15 subbstractive analysis after removing mock signal for "baseline" values

subtractive_nsp15_baseline18S <- subtractive_mock_18S %>% 
  spread(virus, normalized_count) 
subtractive_nsp15_baseline18S[is.na(subtractive_nsp15_baseline18S)] <- 0

subtractive_nsp15_baseline18S <- subtractive_nsp15_baseline18S %>% 
  mutate(MHVS_nsp15 = MHVSbase - nsp15base) %>% 
  mutate(MHVV_nsp15 = MHVVbase - nsp15base) %>% 
  mutate(ns2_nsp15 = ns2base - nsp15base) %>% 
  dplyr::select(start:end, cell:time, MHVS_nsp15:ns2_nsp15) %>% 
  gather(virus, normalized_count, MHVS_nsp15:ns2_nsp15)
                                      
subnsp15_baseline18S_plot <- 
  ggplot(subtractive_nsp15_baseline18S, aes(x = end, y = normalized_count)) +
    geom_line(aes(color = time)) + 
    scale_colour_brewer(palette = 'Set1') + 
    theme_cowplot() + 
    scale_y_continuous(limits = c(0, 0.02)) + 
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
     scale_x_continuous(breaks=seq(0, 2000, 250)) + 
    ggtitle("Baseline 18S rRNA nsp15 dependent analysis") 
subnsp15_baseline18S_plot

#28S

subtractive_nsp15_baseline28S <- subtractive_mock_28S %>% 
  spread(virus, normalized_count) 
subtractive_nsp15_baseline28S[is.na(subtractive_nsp15_baseline28S)] <- 0

subtractive_nsp15_baseline28S <- subtractive_nsp15_baseline28S %>% 
  mutate(MHVS_nsp15 = MHVSbase - nsp15base) %>% 
  mutate(MHVV_nsp15 = MHVVbase - nsp15base) %>% 
  mutate(ns2_nsp15 = ns2base - nsp15base) %>% 
  dplyr::select(start:end, cell:time, MHVS_nsp15:ns2_nsp15) %>% 
  gather(virus, normalized_count, MHVS_nsp15:ns2_nsp15)
                                      
subnsp15_baseline28S_plot <- ggplot(subtractive_nsp15_baseline28S, aes(x = end, y = normalized_count)) +
    #geom_bar(aes(fill = time), stat = "identity", position = 'dodge') +
    geom_line(aes(color = time)) + 
    scale_color_brewer(palette = 'Set1') + 
    theme_cowplot() + 
    scale_y_continuous(limits = c(0, 0.01)) + 
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_x_continuous(breaks=seq(0, 5000, 500)) + 
    ggtitle("Baseline 28S rRNA nsp15 dependent analysis") 
subnsp15_baseline28S_plot

#5S

subtractive_nsp15_baseline5S <- subtractive_mock_5S %>% 
  spread(virus, normalized_count) 
subtractive_nsp15_baseline5S[is.na(subtractive_nsp15_baseline5S)] <- 0

subtractive_nsp15_baseline5S <- subtractive_nsp15_baseline5S %>% 
  mutate(MHVS_nsp15 = MHVSbase - nsp15base) %>% 
  mutate(MHVV_nsp15 = MHVVbase - nsp15base) %>% 
  mutate(ns2_nsp15 = ns2base - nsp15base) %>% 
  dplyr::select(start:end, cell:time, MHVS_nsp15:ns2_nsp15) %>% 
  gather(virus, normalized_count, MHVS_nsp15:ns2_nsp15)
                                      
subnsp15_baseline5S_plot <- ggplot(subtractive_nsp15_baseline5S, aes(x = end, y = normalized_count, fill = time)) +
    geom_bar(stat = "identity", position = 'dodge') +
    #geom_line(aes(color = time)) + 
    scale_fill_brewer(palette = 'Set1') + 
    theme_cowplot() + 
    scale_y_continuous(limits = c(0, 0.01)) + 
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_x_continuous(breaks=seq(0, 200, 20)) + 
    ggtitle("Baseline 5S rRNA nsp15 dependent analysis") 
subnsp15_baseline5S_plot


```

### Discussion of nsp15 dependent analysis after baseline substraction

The nsp15 substractive analysis at baseline is very similar to the original analysis without removing the mock signal. However, there is a some what clearer peak in the beginning region of the 18s RNA in the RNase L KO cells, but not in the RNase L KO cells infected with ns2 mutant virus. In both the 18s and 28s rRNA, there is almost no nsp15-dependnent signal captured in the RNase L KO cells infected with ns2 mutant virus. But, there is signal in the RNase L substratcive analysis. This suggests that nsp15 cleavage is being inhibited by the mutant nsp15 virus. In the 5s rRNA there is very little singal, expect for this peak around 50 nt that only occurs in the IFNAR KO cells. This signal also occurs in the RNase L dependent analysis, so it is msot likely actually dependnent on another unknown factor. 

Overall, there are still significant differences in signal captured between the cell types and types of viral infections, suggesting there are several interactions contributing to these cleavage events. 

## Calcualting dinucelotide frequencies for all cell types by type of viral infection 

Performing a dinucleotide frequency analysis will help us to confirm RNaseL signatures as a positive control and investigate a potential sequence preference for nsp15 cleavage.

```{r message = F, warning = F}

dinuc <- c("AA","GA", "CA", "UA","AC", "CC", "GC", "UC", "AG", "CG", "GG", "UG", "AU", "CU", "GU", "UU")
df_dinuc <- data_frame(dinuc)

#18S dinuc frequency 

frequencies_18S <- function(x) {
  df <- readr::read_tsv(x, col_names = c("chrom", "start", "end", "count", "normalized_count", "dinuc"))
  df <- aggregate(cbind(count) ~ dinuc, data = df, sum)
  df <- left_join(df_dinuc, df) %>% replace_na(list(count = 0)) %>% 
  mutate(freq = count/sum(count))
  df$name <- basename(x)
  df %>% mutate(name = str_replace(name, ".umi.18S.dinuc.neg.bg", "")) %>%
  separate(name, into = c('cell', 'virus', 'time'))
}

freq_18S <- purrr::map_df(data_files_18S, frequencies_18S)

#28S dinuc frequency 

frequencies_28S <- function(x) {
  df <- readr::read_tsv(x, col_names = c("chrom", "start", "end", "count", "normalized_count", "dinuc"))
  df <- aggregate(cbind(count) ~ dinuc, data = df, sum)
  df <- left_join(df_dinuc, df) %>% replace_na(list(count = 0)) %>% 
  mutate(freq = count/sum(count))
  df$name <- basename(x)
  df %>% mutate(name = str_replace(name, ".umi.28S.dinuc.neg.bg", "")) %>%
  separate(name, into = c('cell', 'virus', 'time'))
}

freq_28S <- purrr::map_df(data_files_28S, frequencies_28S)

# 5S dinuc frequency 

frequencies_5S <- function(x) {
  df <- readr::read_tsv(x, col_names = c("chrom", "start", "end", "count", "normalized_count", "dinuc"))
  df <- aggregate(cbind(count) ~ dinuc, data = df, sum)
  df <- left_join(df_dinuc, df) %>% replace_na(list(count = 0)) %>% 
  mutate(freq = count/sum(count))
  df$name <- basename(x)
  df %>% mutate(name = str_replace(name, ".umi.5S.dinuc.neg.bg", "")) %>%
  separate(name, into = c('cell', 'virus', 'time'))
} 

freq_5S <- purrr::map_df(data_files_5S, frequencies_5S)

```

## Graphing dinucleotide frequencies for all cell types by infection status

```{r message = F, warning = F}

#18S dinuc freq plots 

freq_18S_plot <- freq_18S %>%
  ggplot(aes(x = dinuc,y = freq, fill = time)) + 
  scale_fill_brewer(palette = 'Set1') + 
  scale_x_discrete(limits=c("AA","GA", "CA", "UA","AC", "CC", "GC", "UC", "AG", "CG", "GG",     "UG", "AU", "CU", "GU", "UU")) + 
  geom_bar(stat = "identity", position = 'dodge') + 
  theme_cowplot() +
  facet_grid(virus ~ cell) +  
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) +
  ggtitle("18S dinucleotide frequency plots ") 
freq_18S_plot

#28S dinuc freq plots 

freq_28S_plot <- freq_28S %>%
  ggplot(aes(x = dinuc,y = freq, fill = time)) + 
  scale_fill_brewer(palette = 'Set1') + 
  scale_x_discrete(limits=c("AA","GA", "CA", "UA","AC", "CC", "GC", "UC", "AG", "CG", "GG",     "UG", "AU", "CU", "GU", "UU")) + 
  geom_bar(stat = "identity", position = 'dodge') + 
  theme_cowplot() + 
  facet_grid(virus ~ cell) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) +
  ggtitle("28S dinucleotide frequency plots ") 
freq_28S_plot

#5S dinuc freq plots 

freq_5S_plot <- freq_5S %>%
  ggplot(aes(x = dinuc,y = freq, fill = time)) + 
  scale_fill_brewer(palette = 'Set1') + 
  scale_x_discrete(limits=c("AA","GA", "CA", "UA","AC", "CC", "GC", "UC", "AG", "CG", "GG",     "UG", "AU", "CU", "GU", "UU")) + 
  geom_bar(stat = "identity", position = 'dodge') + 
  theme_cowplot() + 
  facet_grid(virus ~ cell) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) +
  ggtitle("5S dinucleotide frequency plots ") 
freq_5S_plot

```
### Discussion of dinucleotide analysis: 

The significant amount of non-specific rRNA cleavage makes it difficult to draw conclusions about the dinucleotide cleavage patterns. There relative frequencies and patterns of cleavage in the mock samples are very similar to that observed in the treated samples across all rRNAs. There may be some small differences in frequenct for robust RNase L cleavage sites preferences (UA, UU) between B6 and IFNAR/RNase L KO cells, but overall they are not robust or particulally clear. 

## RNase L substractive dinucleotide analysis of for all cell types by viral infection 

This is similar to the previous coverage substractive analysis. These plots display dinucleotde cleavage frequencies dependent on RNase L by removing the frequencies detected in the abscence of RNase L. 

```{r message = F, warning = F}

#18S

subtractive_18S <- freq_18S %>% 
  dplyr::select(dinuc, freq:time) %>% 
  spread(cell, freq) %>% 
  mutate(B6_RNaseL = B6 - RNaseL) %>% 
  mutate(IFNAR_RNaseL = IFNAR - RNaseL) %>% 
  dplyr::select(dinuc:time, B6_RNaseL:IFNAR_RNaseL) %>% 
  gather(cell, freq, B6_RNaseL:IFNAR_RNaseL)

sub18S_freq_plot <- subtractive_18S %>% 
  ggplot(aes(x = dinuc , y = freq)) + 
  scale_fill_brewer(palette = 'Set1') + 
  scale_x_discrete(limits=c("AA","GA", "CA", "UA","AC", "CC", "GC", "UC", "AG", "CG", "GG",     "UG", "AU", "CU", "GU",      "UU")) + 
  geom_bar(aes(fill = time), stat = "identity", position = 'dodge') + 
  theme_cowplot() + 
  facet_grid(virus ~ cell) + 
  scale_y_continuous(limits = c(0.00, 0.04)) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) +
  ggtitle("18S RNase L subtractive dinucleotide frequency plots ") 
sub18S_freq_plot

#28S

subtractive_28S <- freq_28S %>% 
  dplyr::select(dinuc, freq:time) %>% 
  spread(cell, freq) %>% 
  mutate(B6_RNaseL = B6 - RNaseL) %>% 
  mutate(IFNAR_RNaseL = IFNAR - RNaseL) %>% 
  dplyr::select(dinuc:time, B6_RNaseL:IFNAR_RNaseL) %>% 
  gather(cell, freq, B6_RNaseL:IFNAR_RNaseL)

sub28S_freq_plot <- subtractive_28S %>%
  ggplot(aes(x = dinuc , y = freq)) + 
  scale_fill_brewer(palette = 'Set1') + 
  scale_x_discrete(limits=c("AA","GA", "CA", "UA","AC", "CC", "GC", "UC", "AG", "CG", "GG",     "UG", "AU", "CU", "GU",      "UU")) + 
  geom_bar(aes(fill = time), stat = "identity", position = 'dodge') + 
  theme_cowplot() + 
  facet_grid(virus ~ cell) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) + 
  scale_y_continuous(limits = c(-0.0, 0.06)) +
  ggtitle("28S RNase L subtractive dinucleotide frequency plots ") 
sub28S_freq_plot

#5S

subtractive_5S <- freq_5S %>% 
  dplyr::select(dinuc, freq:time) %>% 
  spread(cell, freq) %>% 
  mutate(B6_RNaseL = B6 - RNaseL) %>% 
  mutate(IFNAR_RNaseL = IFNAR - RNaseL) %>% 
  dplyr::select(dinuc:time, B6_RNaseL:IFNAR_RNaseL) %>% 
  gather(cell, freq, B6_RNaseL:IFNAR_RNaseL)

sub5S_freq_plot <- subtractive_5S %>%
  ggplot(aes(x = dinuc , y = freq)) + 
  scale_fill_brewer(palette = 'Set1') + 
  scale_x_discrete(limits=c("AA","GA", "CA", "UA","AC", "CC", "GC", "UC", "AG", "CG", "GG", "UG", "AU", "CU", "GU",      "UU")) + 
  geom_bar(aes(fill = time), stat = "identity", position = 'dodge') + 
  theme_cowplot() + 
    facet_grid(virus ~ cell) + 
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) + 
    scale_y_continuous(limits = c(-0.0, 0.06)) +
    ggtitle("5S RNase L subtractive dinucleotide frequency plots ") 
sub5S_freq_plot


```

### Discussion of RNase L subtractive dinucleotide analysis

The subtractive analysis does faciliate some additional discrmination between "background" frquencies evident in the mock samples from patterns that appear more specific to the treated samples. Although overall the patterns aren't very consistent, cleavage at dinucleotides where the 3´-position is U or C have the greatest frequencies of cleavage, especially in the B6 cells. In the 28s rRNA, a preference for UA, UG, UC, and UU is more pronounced. 

## Nsp15 subtractive dinucleotide analysis of for all cell types by viral infection 

```{r message = F, warning = F}

#18S

endoU_subtractive_18S <- freq_18S %>% 
  dplyr::select(dinuc, freq:time) %>% 
  spread(virus, freq) %>% 
  mutate(MHVS_nsp15 = MHVS - nsp15) %>% 
  mutate(MHVV_nsp15 = MHVV - nsp15) %>% 
  mutate(ns2_nsp15 = ns2 - nsp15) %>% 
  mutate(mock_nsp15 = mock - nsp15) %>% 
  dplyr::select(dinuc:time, MHVS_nsp15:mock_nsp15) %>% 
  gather(virus, freq, MHVS_nsp15:mock_nsp15)

endoU_sub18S_freq_plot <- endoU_subtractive_18S %>% 
  ggplot(aes(x = dinuc , y = freq, fill = time)) + 
  scale_fill_brewer(palette = 'Set1') + 
  scale_x_discrete(limits=c("AA","GA", "CA", "UA","AC", "CC", "GC", "UC", "AG", "CG", "GG",     "UG", "AU", "CU", "GU",      "UU")) + 
  geom_bar(stat = "identity", position = 'dodge') + 
  theme_cowplot() + 
  scale_y_continuous(limits = c(0.00, 0.06)) +
  facet_grid(virus ~ cell) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) +
  ggtitle("18S nsp15 subtractive dinucleotide frequency plots ") 
endoU_sub18S_freq_plot

#28S

endoU_subtractive_28S <- 
  freq_28S %>% 
  dplyr::select(dinuc, freq:time) %>% 
  spread(virus, freq) %>% 
  mutate(MHVS_nsp15 = MHVS - nsp15) %>% 
  mutate(MHVV_nsp15 = MHVV - nsp15) %>% 
  mutate(ns2_nsp15 = ns2 - nsp15) %>% 
  mutate(mock_nsp15 = mock - nsp15) %>% 
  dplyr::select(dinuc:time, MHVS_nsp15:mock_nsp15) %>% 
  gather(virus, freq, MHVS_nsp15:mock_nsp15)

endoU_sub28S_freq_plot <- endoU_subtractive_28S %>% 
  ggplot(aes(x = dinuc , y = freq, fill = time)) + 
  scale_fill_brewer(palette = 'Set1') + 
  scale_x_discrete(limits=c("AA","GA", "CA", "UA","AC", "CC", "GC", "UC", "AG", "CG", "GG",     "UG", "AU", "CU", "GU", "UU")) + 
  geom_bar(stat = "identity", position = 'dodge') + 
  theme_cowplot() + 
  scale_y_continuous(limits = c(0.0, 0.06)) +
  facet_grid(virus ~ cell) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) +
  ggtitle("28S nsp15 subtractive dinucleotide frequency plots ") 
endoU_sub28S_freq_plot

#5S

endoU_subtractive_5S <- freq_5S %>% 
  dplyr::select(dinuc, freq:time) %>% 
  spread(virus, freq) %>% 
  mutate(MHVS_nsp15 = MHVS - nsp15) %>% 
  mutate(MHVV_nsp15 = MHVV - nsp15) %>% 
  mutate(ns2_nsp15 = ns2 - nsp15) %>% 
  mutate(mock_nsp15 = mock - nsp15) %>% 
  dplyr::select(dinuc:time, MHVS_nsp15:mock_nsp15) %>% 
  gather(virus, freq, MHVS_nsp15:mock_nsp15)

endoU_sub5S_freq_plot <- endoU_subtractive_5S %>% 
  ggplot(aes(x = dinuc , y = freq, fill = time)) + 
  scale_fill_brewer(palette = 'Set1') + 
  scale_x_discrete(limits=c("AA","GA", "CA", "UA","AC", "CC", "GC", "UC", "AG", "CG", "GG",     "UG", "AU", "CU", "GU", "UU")) + 
  geom_bar(aes(fill = time), stat = "identity", position = 'dodge') + 
  theme_cowplot() + 
  scale_y_continuous(limits = c(0.0, 0.06)) +
  facet_grid(cell ~ virus) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) +
  ggtitle("5S nsp15 subtractive dinucleotide frequency plots ") 
endoU_sub5S_freq_plot


```

### Discussion of nsp15 subtractive analysis: 

For each rRNA, there were no obvious differences in dincuelotide cleavage preferecnce between the mock and infected samples. Whereas the RNase L subtractive analysis exposed some differences in dincleotide cleavage frequency between the mock and infected samples, which suggests that there is no nsp15 dependent cleavage preference in rRNA or that the cleavage freuqncy is less robust than RNase L and cannot be distinguished from the background. 
